# Caddyfile - Configuration reverse proxy avec HTTPS automatique

# Configuration globale pour Let's Encrypt
{
    email {env.CADDY_EMAIL}
}

# Redirection HTTP vers HTTPS
http://ratios.futurdigitaln8n.ch {
    redir https://ratios.futurdigitaln8n.ch{uri} permanent
}

# Configuration HTTPS principale
https://ratios.futurdigitaln8n.ch {
    # Reverse proxy vers l'API
    reverse_proxy /api/* app:8000
    
    # Health check endpoint
    reverse_proxy /health app:8000
    
    # Headers de sécurité
    header {
        # Protection XSS
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        
        # HSTS (6 mois)
        Strict-Transport-Security "max-age=15552000; includeSubDomains; preload"
        
        # CSP basique pour API
        Content-Security-Policy "default-src 'none'; frame-ancestors 'none';"
        
        # Cacher la version du serveur
        -Server
    }
    
    # Rate limiting géré par l'API (SlowAPI)
    
    # Logs structurés
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 24h
        }
        format json
        level INFO
    }
    
    # Page d'erreur pour les routes non-API seulement
    handle /* {
        respond "API Ratios - Endpoints: /api/v1/webhook, /health" 404
    }
}

# Configuration pour développement local (optionnel)
localhost:80, 127.0.0.1:80 {
    reverse_proxy app:8000
    
    log {
        level DEBUG
    }
} 